// This is your Prisma schema file.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- Enums for Type Safety ---

enum Role {
  passenger
  driver
  admin
}

enum DriverStatus {
  active
  inactive
  on_break
  off_duty
}

enum BusStatus {
  idle
  moving
  arrived
  offline
  maintenance
}

enum BusDirection {
  forward
  backward
}

enum BookingStatus {
  pending
  confirmed
  in_progress
  completed
  cancelled
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum LocationSource {
  gps
  manual
  simulator
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  INSURANCE
  MOBILE_MONEY_AUTOMATED
}

// --- Core Models ---

model User {
  id              Int       @id @default(autoincrement())
  name            String
  email           String    @unique
  password        String
  role            Role      @default(passenger)
  phone           String?
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  isActive        Boolean   @default(true) @map("is_active")
  otp             String?
  otpExpiresAt    DateTime? @map("otp_expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // --- Relationships ---
  driverProfile Driver?
  bookings      Booking[]
  notifications Notification[]

  @@map("users")
}

model Driver {
  id            Int          @id @default(autoincrement())
  name          String
  phone         String
  licenseNumber String       @unique @map("license_number")
  status        DriverStatus @default(off_duty)
  rating        Float        @default(0.0)
  totalTrips    Int          @default(0) @map("total_trips")
  isVerified    Boolean      @default(false) @map("is_verified")

  // --- Relationships ---
  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique @map("user_id")

  bus  Bus?
  trips Trip[]

  @@map("drivers")
}

model Route {
  id                       Int      @id @default(autoincrement())
  name                     String
  description              String?
  polyline                 String?
  color                    String?  @default("#007bff")
  distanceKm               Decimal? @map("distance_km")
  estimatedDurationMinutes Int?     @map("estimated_duration_minutes")
  fareAmount               Decimal? @map("fare_amount")
  isActive                 Boolean  @default(true) @map("is_active")

  // --- Relationships ---
  stops    Stop[]
  buses    Bus[]
  bookings Booking[]
  trips    Trip[]

  @@map("routes")
}

model Stop {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  latitude    Float
  longitude   Float
  stopOrder   Int     @map("stop_order")
  zone        String?
  amenities   Json?   @default("[]")
  isMajor     Boolean @default(false) @map("is_major")
  isActive    Boolean @default(true) @map("is_active")

  // --- Relationships ---
  route   Route @relation(fields: [routeId], references: [id])
  routeId Int   @map("route_id")

  busesAtStop       Bus[] @relation("CurrentStop")
  busesComingToStop Bus[] @relation("NextStop")

  departureBookings Booking[] @relation("FromStop")
  arrivalBookings   Booking[] @relation("ToStop")

  @@unique([routeId, stopOrder])
  @@index([latitude, longitude])
  @@map("stops")
}

model Bus {
  id               Int          @id @default(autoincrement())
  busNumber        String       @unique @map("bus_number")
  vehiclePlate     String       @unique @map("vehicle_plate")
  vehicleModel     String?      @map("vehicle_model")
  capacity         Int          @default(30)
  currentOccupancy Int          @default(0) @map("current_occupancy")
  status           BusStatus    @default(idle)
  direction        BusDirection @default(forward)
  isTracked        Boolean      @default(true) @map("is_tracked")
  lastLocationLat  Float?       @map("last_location_lat")
  lastLocationLng  Float?       @map("last_location_lng")
  lastSpeedKmh     Decimal?     @map("last_speed_kmh")
  lastUpdate       DateTime?    @map("last_update")

  // --- Relationships ---
  route   Route @relation(fields: [routeId], references: [id])
  routeId Int   @map("route_id")

  driver   Driver? @relation(fields: [driverId], references: [id])
  driverId Int?    @unique @map("driver_id")

  currentStop   Stop? @relation("CurrentStop", fields: [currentStopId], references: [id])
  currentStopId Int?  @map("current_stop_id")

  nextStop   Stop? @relation("NextStop", fields: [nextStopId], references: [id])
  nextStopId Int?  @map("next_stop_id")

  locationUpdates LocationUpdate[]
  bookings        Booking[]
  trips           Trip[]

  @@map("buses")
}

model LocationUpdate {
  id        Int            @id @default(autoincrement())
  latitude  Float
  longitude Float
  speedKmh  Decimal?       @map("speed_kmh")
  heading   Decimal?
  altitude  Decimal?
  accuracy  Decimal?
  timestamp DateTime       @default(now())
  source    LocationSource @default(gps)
  isValid   Boolean        @default(true) @map("is_valid")

  bus   Bus @relation(fields: [busId], references: [id])
  busId Int @map("bus_id")

  @@index([busId, timestamp])
  @@map("location_updates")
}

model Booking {
  id                 String        @id @default(cuid())
  seatCount          Int           @default(1) @map("seat_count")
  totalFare          Decimal       @map("total_fare")
  bookingReference   String        @unique @map("booking_reference")
  status             BookingStatus @default(pending)
  paymentStatus      PaymentStatus @default(pending) @map("payment_status")
  bookingTime        DateTime      @default(now()) @map("booking_time")
  travelDate         DateTime      @map("travel_date")
  passengerName      String?       @map("passenger_name")
  passengerPhone     String?       @map("passenger_phone")
  specialRequests    String?       @map("special_requests")
  notes              String?
  cancelledAt        DateTime?     @map("cancelled_at")
  cancellationReason String?       @map("cancellation_reason")

  // --- Relationships ---
  user   User @relation(fields: [userId], references: [id])
  userId Int  @map("user_id")

  bus   Bus @relation(fields: [busId], references: [id])
  busId Int @map("bus_id")

  route   Route @relation(fields: [routeId], references: [id])
  routeId Int   @map("route_id")

  fromStop   Stop @relation("FromStop", fields: [fromStopId], references: [id])
  fromStopId Int  @map("from_stop_id")

  toStop   Stop @relation("ToStop", fields: [toStopId], references: [id])
  toStopId Int  @map("to_stop_id")

  // A Booking has one Payment
  payment Payment?

  @@index([travelDate])
  @@map("bookings")
}

model Trip {
  id           String    @id @default(cuid())
  distanceKm   Float     @map("distance_km")
  durationMins Int       @map("duration_mins")
  status       String
  startedAt    DateTime  @default(now()) @map("started_at")
  endedAt      DateTime? @map("ended_at")

  // --- Relationships ---
  driver   Driver @relation(fields: [driverId], references: [id])
  driverId Int    @map("driver_id")

  route   Route @relation(fields: [routeId], references: [id])
  routeId Int   @map("route_id")

  bus   Bus @relation(fields: [busId], references: [id])
  busId Int @map("bus_id")

  @@index([driverId])
  @@map("trips")
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal
  method         PaymentMethod
  status         PaymentStatus @default(pending)
  transactionRef String?       @unique @map("transaction_ref")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // --- Relationship ---
  // A Payment belongs to one Booking
  booking   Booking @relation(fields: [bookingId], references: [id])
  bookingId String  @unique @map("booking_id")

  @@map("payments")
}

model Notification {
  id        Int      @id @default(autoincrement())
  message   String
  type      String   @default("INFO") // e.g., INFO, WARNING, SUCCESS
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // --- Relationship ---
  user   User @relation(fields: [userId], references: [id])
  userId Int  @map("user_id")

  @@map("notifications")
}